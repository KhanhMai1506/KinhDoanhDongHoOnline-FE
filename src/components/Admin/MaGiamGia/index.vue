<template>

    <div class="row">
        <div class="col-lg-3">
            <div class="card">
                <div class="card-header">
                    <h5><b class="align-middle">TH√äM M∆†ÃÅI M√É GI·∫¢M GI√Å</b></h5>
                </div>
                <div class="card-body">
                    <div class="mb-2">
                        <label>M√£ Code</label>
                        <input v-model="create_ma_giam_gia.code" type="text" class="form-control mt-2">
                    </div>
                    <div class="mb-2">
                        <label>Th·ªùi Gian B·∫Øt ƒê·∫ßu</label>
                        <input v-model="create_ma_giam_gia.ngay_bat_dau" type="date" class="form-control mt-2">
                    </div>
                    <div class="mb-2">
                        <label>Th·ªùi Gian K·∫øt Th√∫c</label>
                        <input v-model="create_ma_giam_gia.ngay_ket_thuc" type="date" class="form-control mt-2">
                    </div>
                    <div class="mb-2">
                        <label>Lo·∫°i Gi·∫£m</label>
                        <select v-model="create_ma_giam_gia.loai_giam_gia" class="form-control mt-2">
                            <option value="0">Gi·∫£m %</option>
                            <option value="1">Ti·ªÅn M·∫∑t</option>
                        </select>
                    </div>
                    <div class="mb-2">
                        <label>S·ªë Gi·∫£m Gi√°</label>
                        <input v-model="create_ma_giam_gia.so_giam_gia" type="number" class="form-control mt-2">
                    </div>
                    <div class="mb-2">
                        <label>S·ªë Ti·ªÅn T·ªëi ƒêa</label>
                        <input v-model="create_ma_giam_gia.so_tien_toi_da" type="number" class="form-control mt-2">
                    </div>
                    <div class="mb-2">
                        <label>ƒê∆°n H√†ng T·ªëi Thi·ªÉu</label>
                        <input v-model="create_ma_giam_gia.don_hang_toi_thieu" type="number" class="form-control mt-2">
                    </div>
                    <div class="mb-2">
                        <label>TiÃÄnh traÃ£ng</label>
                        <select v-model="create_ma_giam_gia.tinh_trang" class="form-control mt-2">
                            <option value="0">T·∫°m T·∫Øt</option>
                            <option value="1">Hi·ªÉn Th·ªã</option>
                        </select>
                    </div>
                </div>
                <div class="card-footer text-end">
                    <button v-on:click="themMoiMaGiamGia()" class="btn btn-primary">Th√™m M∆°ÃÅi</button>
                </div>
            </div>
        </div>
        <div class="col-lg-9">
            <div class="card">
                <div class="card-header">
                    <h5><b class="align-middle">DANH SAÃÅCH M√É GI·∫¢M GI√Å</b></h5>
                </div>
                <div class="card-body table-responsive">
                    <table class="table table-bordered table-hover">
                        <thead>
                            <tr>
                                <th class="text-center">#</th>
                                <th class="text-center">M√£ Code</th>
                                <th class="text-center">Th·ªùi Gian B·∫Øt ƒê·∫ßu</th>
                                <th class="text-center">Th·ªùi Gian K·∫øt Th√∫c</th>
                                <th class="text-center">Lo·∫°i Gi·∫£m</th>
                                <th class="text-center">S·ªë Gi·∫£m Gi√°</th>
                                <th class="text-center">S·ªë Ti·ªÅn T·ªëi ƒêa</th>
                                <th class="text-center">ƒê∆°n H√†ng T·ªëi Thi·ªÉu</th>
                                <th class="text-center">TiÃÄnh TraÃ£ng</th>
                                <th class="text-center">Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            <template v-for="(value, index) in list_ma_giam_gia" :key="index">
                                <tr>
                                    <th class="align-middle">{{ index + 1 }}</th>
                                    <td class="align-middle">{{ value.code }}</td>
                                    <td class="align-middle text-center">{{ value.ngay_bat_dau }}</td>
                                    <td class="align-middle text-center">{{ value.ngay_ket_thuc }}</td>
                                    <td class="align-middle">
                                        <template v-if="value.loai_giam_gia == 0">
                                            Gi·∫£m %
                                        </template>
                                        <template v-else>
                                            Ti·ªÅn M·∫∑t
                                        </template>
                                    </td>
                                    <td class="align-middle text-end">{{ value.so_giam_gia }}</td>
                                    <td class="align-middle text-end">{{ value.so_tien_toi_da }}</td>
                                    <td class="align-middle text-end">{{ value.don_hang_toi_thieu }}</td>
                                    <td class="align-middle text-center">
                                        <button v-on:click="changeTrangThai(value)" v-if="value.tinh_trang == 1"
                                            class="btn btn-success">Hi√™Ãân thiÃ£</button>
                                        <button v-on:click="changeTrangThai(value)" v-else class="btn btn-danger">TaÃ£m
                                            tƒÉÃÅt</button>
                                    </td>
                                    <td class="align-middle text-center">
                                        <button v-on:click="Object.assign(edit_ma_giam_gia, value)"
                                            class="btn btn-primary me-2" data-bs-toggle="modal"
                                            data-bs-target="#capnhatDM">C√¢Ã£p nh√¢Ã£t</button>
                                        <button v-on:click="del_ma_giam_gia = value" class="btn btn-danger"
                                            data-bs-toggle="modal" data-bs-target="#delModal">XoÃÅa</button>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </div>

        </div>
        <div class="modal fade" id="delModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h1 class="modal-title fs-5" id="exampleModalLabel">XoÃÅa M√£ Gi·∫£m Gi√°</h1>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="alert alert-danger" role="alert">
                            BaÃ£n coÃÅ chƒÉÃÅc mu√¥ÃÅn xoÃÅa <b class="text-danger">{{ del_ma_giam_gia.code }}</b> naÃÄy kh√¥ng?
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button v-on:click="xoaMaGiamGia()" type="button" class="btn btn-primary"
                            data-bs-dismiss="modal">XaÃÅc
                            nh√¢Ã£n</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal fade" id="capnhatDM" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h1 class="modal-title fs-5" id="exampleModalLabel">C√¢Ã£p Nh√¢Ã£t M√£ Gi·∫£m Gi√°</h1>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-2">
                            <label>M√£ Code</label>
                            <input v-model="edit_ma_giam_gia.code" type="text" class="form-control mt-2">
                        </div>
                        <div class="mb-2">
                            <label>Th·ªùi Gian B·∫Øt ƒê·∫ßu</label>
                            <input v-model="edit_ma_giam_gia.ngay_bat_dau" type="date" class="form-control mt-2">
                        </div>
                        <div class="mb-2">
                            <label>Th·ªùi Gian K·∫øt Th√∫c</label>
                            <input v-model="edit_ma_giam_gia.ngay_ket_thuc" type="date" class="form-control mt-2">
                        </div>
                        <div class="mb-2">
                            <label>Lo·∫°i Gi·∫£m</label>
                            <select v-model="edit_ma_giam_gia.loai_giam_gia" class="form-control mt-2">
                                <option value="0">Gi·∫£m %</option>
                                <option value="1">Ti·ªÅn M·∫∑t</option>
                            </select>
                        </div>
                        <div class="mb-2">
                            <label>S·ªë Gi·∫£m Gi√°</label>
                            <input v-model="edit_ma_giam_gia.so_giam_gia" type="number" class="form-control mt-2">
                        </div>
                        <div class="mb-2">
                            <label>S·ªë Ti·ªÅn T·ªëi ƒêa</label>
                            <input v-model="edit_ma_giam_gia.so_tien_toi_da" type="number" class="form-control mt-2">
                        </div>
                        <div class="mb-2">
                            <label>ƒê∆°n H√†ng T·ªëi Thi·ªÉu</label>
                            <input v-model="edit_ma_giam_gia.don_hang_toi_thieu" type="number"
                                class="form-control mt-2">
                        </div>
                        <div class="mb-2">
                            <label>TiÃÄnh traÃ£ng</label>
                            <select v-model="edit_ma_giam_gia.tinh_trang" class="form-control mt-2">
                                <option value="0">T·∫°m T·∫Øt</option>
                                <option value="1">Hi·ªÉn Th·ªã</option>
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button v-on:click="capnhatMaGiamGia()" type="button" class="btn btn-primary">C√¢Ã£p
                            nh√¢Ã£t</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</template>
<script>
import axios from 'axios';

export default {
    data() {
        return {
            list_ma_giam_gia: [],
            create_ma_giam_gia: {},
            del_ma_giam_gia: {},
            edit_ma_giam_gia: {},
        }
    },
    mounted() {
        this.layDataMaGiamGia();
    },
    methods: {
        layDataMaGiamGia() {
            axios
                .get("http://127.0.0.1:8000/api/admin/ma-giam-gia/data", {
                    headers: {
                        Authorization: 'Bearer ' + localStorage.getItem("token_admin")
                    }
                })
                .then((res) => {
                    this.list_ma_giam_gia = res.data.data;
                })
        },
        themMoiMaGiamGia() {
            const requiredFields = [
                'code',
                'ngay_bat_dau',
                'ngay_ket_thuc',
                'loai_giam_gia',
                'so_giam_gia',
                'don_hang_toi_thieu',
                'tinh_trang'
            ];

            // Ki·ªÉm tra r·ªóng
            for (const field of requiredFields) {
                if (
                    this.create_ma_giam_gia[field] === undefined ||
                    this.create_ma_giam_gia[field] === null ||
                    this.create_ma_giam_gia[field].toString().trim() === ''
                ) {
                    this.$toast.warning("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß t·∫•t c·∫£ c√°c tr∆∞·ªùng b·∫Øt bu·ªôc!");
                    return;
                }
            }

            // ‚úÖ Ki·ªÉm tra logic theo lo·∫°i gi·∫£m
            if (this.create_ma_giam_gia.loai_giam_gia == 0) {
                // Gi·∫£m %
                if (
                    this.create_ma_giam_gia.so_tien_toi_da === undefined ||
                    this.create_ma_giam_gia.so_tien_toi_da === null ||
                    this.create_ma_giam_gia.so_tien_toi_da.toString().trim() === '' ||
                    Number(this.create_ma_giam_gia.so_giam_gia) <= 0 ||
                    Number(this.create_ma_giam_gia.so_giam_gia) > 100
                ) {
                    this.$toast.warning("Vui l√≤ng nh·∫≠p S·ªë Gi·∫£m Gi√° ( > 0 & <= 100 ) khi ch·ªçn Gi·∫£m %!");
                    return;
                }
            } else if (this.create_ma_giam_gia.loai_giam_gia == 1) {
                // Ti·ªÅn m·∫∑t
                if (Number(this.create_ma_giam_gia.so_tien_toi_da) !== 0) {
                    this.$toast.warning("Khi ch·ªçn Ti·ªÅn m·∫∑t, S·ªë Ti·ªÅn T·ªëi ƒêa ph·∫£i b·∫±ng 0!");
                    return;
                }
            }

            // ‚úÖ Ki·ªÉm tra logic ng√†y
            const bd = new Date(this.create_ma_giam_gia.ngay_bat_dau);
            const kt = new Date(this.create_ma_giam_gia.ngay_ket_thuc);

            if (bd > kt) {
                this.$toast.warning("Ng√†y b·∫Øt ƒë·∫ßu kh√¥ng ƒë∆∞·ª£c l·ªõn h∆°n ng√†y k·∫øt th√∫c!");
                return;
            }

            // ‚úÖ G·ª≠i d·ªØ li·ªáu l√™n server
            axios
                .post("http://127.0.0.1:8000/api/admin/ma-giam-gia/create", this.create_ma_giam_gia, {
                    headers: {
                        Authorization: 'Bearer ' + localStorage.getItem("token_admin")
                    }
                })
                .then((res) => {
                    if (res.data.status) {
                        this.$toast.success(res.data.message);
                        this.layDataMaGiamGia();
                        this.create_ma_giam_gia = {};
                    } else {
                        this.$toast.error(res.data.message);
                    }
                });
        },

        capnhatMaGiamGia() {
            const requiredFields = [
                'code',
                'ngay_bat_dau',
                'ngay_ket_thuc',
                'loai_giam_gia',
                'so_giam_gia',
                'don_hang_toi_thieu',
                'tinh_trang'
            ];

            // üîç Ki·ªÉm tra r·ªóng
            for (const field of requiredFields) {
                if (
                    this.edit_ma_giam_gia[field] === undefined ||
                    this.edit_ma_giam_gia[field] === null ||
                    this.edit_ma_giam_gia[field].toString().trim() === ''
                ) {
                    this.$toast.warning("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß t·∫•t c·∫£ c√°c tr∆∞·ªùng b·∫Øt bu·ªôc!");
                    return;
                }
            }

            // üîç Ki·ªÉm tra theo lo·∫°i gi·∫£m
            if (this.edit_ma_giam_gia.loai_giam_gia == 0) {
                // Gi·∫£m %
                if (
                    this.edit_ma_giam_gia.so_tien_toi_da === undefined ||
                    this.edit_ma_giam_gia.so_tien_toi_da === null ||
                    this.edit_ma_giam_gia.so_tien_toi_da.toString().trim() === '' ||
                    Number(this.edit_ma_giam_gia.so_giam_gia) <= 0 ||
                    Number(this.edit_ma_giam_gia.so_giam_gia) > 100
                ) {
                    this.$toast.warning("Vui l√≤ng nh·∫≠p S·ªë Gi·∫£m Gi√° ( > 0 & <= 100 ) khi ch·ªçn Gi·∫£m %!");
                    return;
                }
            } else if (this.edit_ma_giam_gia.loai_giam_gia == 1) {
                // Ti·ªÅn m·∫∑t
                if (Number(this.edit_ma_giam_gia.so_tien_toi_da) !== 0) {
                    this.$toast.warning("Khi ch·ªçn Ti·ªÅn m·∫∑t, S·ªë Ti·ªÅn T·ªëi ƒêa ph·∫£i b·∫±ng 0!");
                    return;
                }
            }

            // üîç Ki·ªÉm tra logic ng√†y
            const bd = new Date(this.edit_ma_giam_gia.ngay_bat_dau);
            const kt = new Date(this.edit_ma_giam_gia.ngay_ket_thuc);
            if (bd > kt) {
                this.$toast.warning("Ng√†y b·∫Øt ƒë·∫ßu kh√¥ng ƒë∆∞·ª£c l·ªõn h∆°n ng√†y k·∫øt th√∫c!");
                return;
            }

            // ‚úÖ G·ª≠i request c·∫≠p nh·∫≠t
            axios
                .post("http://127.0.0.1:8000/api/admin/ma-giam-gia/update", this.edit_ma_giam_gia, {
                    headers: {
                        Authorization: 'Bearer ' + localStorage.getItem("token_admin")
                    }
                })
                .then((res) => {
                    var thong_bao = '<b>Th√¥ng b√°o</b><span style="margin-top: 5px">' + res.data.message + '<span>';
                    if (res.data.status) {
                        this.$toast.success(thong_bao);
                        this.layDataMaGiamGia();

                        const modal = bootstrap.Modal.getInstance(document.getElementById('capnhatDM'));
                        if (modal) modal.hide();
                    } else {
                        this.$toast.error(thong_bao);
                    }
                });
        },

        xoaMaGiamGia() {
            axios
                .post("http://127.0.0.1:8000/api/admin/ma-giam-gia/delete", this.del_ma_giam_gia, {
                    headers: {
                        Authorization: 'Bearer ' + localStorage.getItem("token_admin")
                    }
                })
                .then((res) => {
                    if (res.data.status) {
                        var thong_bao = '<b>Th√¥ng b√°o</b><span style="margin-top: 5px">' + res.data.message + '<span>';
                        this.$toast.success(thong_bao);
                        this.layDataMaGiamGia();
                    } else {
                        var thong_bao = '<b>Th√¥ng b√°o</b><span style="margin-top: 5px">' + res.data.message + '<span>';
                        this.$toast.error(thong_bao);
                    }
                })
        },

        changeTrangThai(value) {
            axios
                .post("http://127.0.0.1:8000/api/admin/ma-giam-gia/doi-trang-thai", value, {
                    headers: {
                        Authorization: 'Bearer ' + localStorage.getItem("token_admin")
                    }
                })
                .then((res) => {
                    if (res.data.status) {
                        var thong_bao = '<b>Th√¥ng b√°o</b><span style="margin-top: 5px">' + res.data.message + '<span>';
                        this.$toast.success(thong_bao);
                        this.layDataMaGiamGia();
                    } else {
                        var thong_bao = '<b>Th√¥ng b√°o</b><span style="margin-top: 5px">' + res.data.message + '<span>';
                        this.$toast.error(thong_bao);
                    }
                })
        },
    },
}
</script>
<style></style>
